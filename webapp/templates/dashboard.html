{% extends "base.html" %}
{% block content %}

<section id="objectives" class="page-hero">
  <div class="page-hero__content">
    <h2 class="page-hero__title">Trusted analytics for sensitive reporting</h2>
    <p class="page-hero__subtitle">Coordinate change-point detection, under-reporting heuristics, and global context in one deployment-ready interface.</p>
    <div class="page-hero__actions">
      <a href="#filters" class="btn-primary">Explore insights</a>
      <a href="#outputs" class="btn-secondary">Browse generated files</a>
    </div>
  </div>
  <dl class="page-hero__highlights">
    <div>
      <dt>Coverage</dt>
      <dd>1999&nbsp;–&nbsp;2022 national + global datasets</dd>
    </div>
    <div>
      <dt>Stakeholders</dt>
      <dd>Policy, forensics, program delivery</dd>
    </div>
    <div>
      <dt>Cadence</dt>
      <dd>Automatable nightly or on demand</dd>
    </div>
  </dl>
</section>

<section class="grid gap-6 md:grid-cols-3 objective-cards" aria-label="Project pillars">
  <article class="objective-card">
    <h3>Objectives</h3>
    <ul>
      <li>Surface breakpoints in state-level reporting</li>
      <li>Highlight under-reporting risk by cohort and offender</li>
      <li>Provide rapid situational briefings for leadership</li>
    </ul>
  </article>
  <article class="objective-card">
    <h3>Implementation</h3>
    <ul>
      <li>Reusable Python analytics orchestrated via CLI or UI</li>
      <li>Responsive Flask front end tailored for deployments</li>
      <li>Structured metadata for preview, provenance, and download</li>
    </ul>
  </article>
  <article class="objective-card">
    <h3>Key Results</h3>
    <ul>
      <li>Per-state change-point intelligence with visual assets</li>
      <li>Composite vulnerability rankings grounded in heuristics</li>
      <li>International comparators for situational benchmarking</li>
    </ul>
  </article>
</section>

<section class="stats-grid" aria-label="File inventory summary">
  <div class="stat-card">
    <p class="stat-card__label">Total files</p>
    <p class="stat-card__value">{{ stats.total }}</p>
  </div>
  <div class="stat-card">
    <p class="stat-card__label">Images</p>
    <p class="stat-card__value">{{ stats.images }}</p>
  </div>
  <div class="stat-card">
    <p class="stat-card__label">Tables</p>
    <p class="stat-card__value">{{ stats.tables }}</p>
  </div>
  <div class="stat-card">
    <p class="stat-card__label">Narrative notes</p>
    <p class="stat-card__value">{{ stats.notes }}</p>
  </div>
</section>

<section id="filters" class="panel" aria-label="Filter outputs">
  <form method="get" class="filter-form" x-data="{ conf: Number(new URLSearchParams(window.location.search).get('min_conf') || 0), anom: Number(new URLSearchParams(window.location.search).get('min_anom') || 0) }">
    <div class="filter-form__row">
      <input name="q" value="{{ query }}" placeholder="Search files or states" class="input" />
      <select name="category" class="input">
        {% for c in categories %}<option value="{{ c }}" {% if c==selected_category %}selected{% endif %}>{{ c }}</option>{% endfor %}
      </select>
      <select name="type" class="input">
        {% for t in types %}<option value="{{ t }}" {% if t==selected_type %}selected{% endif %}>{{ t }}</option>{% endfor %}
      </select>
      <input name="state" value="{{ selected_state }}" placeholder="State focus (optional)" class="input" />
      <div class="filter-form__actions">
        <button class="btn-secondary" type="button" onclick="window.location='/'">Clear</button>
        <button class="btn-primary" type="submit">Apply filters</button>
      </div>
    </div>
    <div class="filter-form__row">
      <label class="slider">
        <span>Minimum confidence</span>
        <input type="range" min="0" max="1" step="0.05" x-model="conf" @input="document.querySelectorAll('[data-conf]').forEach(el => el.style.display = Number(el.dataset.conf) >= conf ? '' : 'none')" />
        <input type="hidden" name="min_conf" :value="conf">
        <strong x-text="conf.toFixed(2)"></strong>
      </label>
      <label class="slider">
        <span>Minimum anomaly score</span>
        <input type="range" min="0" max="1" step="0.05" x-model="anom" @input="document.querySelectorAll('[data-anom]').forEach(el => el.style.opacity = Number(el.dataset.anom) >= anom ? 1 : 0.35)" />
        <input type="hidden" name="min_anom" :value="anom">
        <strong x-text="anom.toFixed(2)"></strong>
      </label>
      <p class="filter-form__hint">Filters apply instantly in the grid—submit to refine the data returned from the server.</p>
    </div>
  </form>
</section>

<section id="outputs" class="outputs-grid" aria-live="polite">
  {% if items|length == 0 %}
    <div class="empty-state">
      <h3>No analyses available</h3>
      <p>Adjust your filters or run the full pipeline to regenerate outputs.</p>
    </div>
  {% endif %}

  {% for it in items %}
  <article class="insight-card" data-conf="{{ '%.2f'|format(it.confidence or 0) }}" data-anom="{{ '%.2f'|format(it.anomaly_score or 0) }}">
    <header class="insight-card__header">
      <div>
        <h3>{{ it.name }}</h3>
        <p>{{ it.category }} · {{ it.type|capitalize }}</p>
      </div>
      <div class="insight-card__chips">
        <span class="chip">{{ it.type|capitalize }}</span>
        {% if it.state %}<span class="chip chip--outline">{{ it.state }}</span>{% endif %}
        {% if it.anomaly_score and it.anomaly_score >= 0.25 %}
          <span class="chip chip--alert" title="Potential outlier">Anom {{ '%.2f'|format(it.anomaly_score) }}</span>
        {% endif %}
      </div>
    </header>

    {% if it.thumb %}
      <img src="{{ it.thumb }}" alt="{{ it.name }}" class="insight-card__preview perception-img" loading="lazy">
    {% else %}
      <div class="insight-card__placeholder">No inline preview</div>
    {% endif %}

    <dl class="insight-card__meta">
      <div>
        <dt>Confidence</dt>
        <dd>
          <span class="meter" style="--v: {{ (it.confidence or 0) }}"></span>
          <span>{{ '%.2f'|format(it.confidence or 0) }}</span>
        </dd>
      </div>
      <div>
        <dt>File size</dt>
        <dd>{{ it.size }}</dd>
      </div>
      <div>
        <dt>Updated</dt>
        <dd>{{ it.updated_at }}</dd>
      </div>
    </dl>

    <div class="insight-card__actions">
      <button type="button" class="btn-ghost" @click="$dispatch('open-preview', { id: '{{ it.id }}', name: '{{ it.name }}', src: '{{ it.thumb or '' }}' })">Preview</button>
      <button type="button" class="btn-ghost" @click="$dispatch('open-provenance', { name: '{{ it.name }}', trail: {{ it.provenance|tojson }} })">Provenance</button>
      <a class="btn-primary" href="{{ url_for('download_by_id', item_id=it.id) }}">Download</a>
    </div>
  </article>
  {% endfor %}

  <!-- Preview Modal -->
  <div x-data="{ open:false, item:{} }" @open-preview.window="item=$event.detail; open=true" x-show="open" x-transition.opacity class="modal" role="dialog" aria-modal="true">
    <div class="modal__backdrop" @click="open=false"></div>
    <div class="modal__panel">
      <div class="modal__content">
        <div class="modal__header">
          <h4 x-text="item.name"></h4>
          <button class="btn-ghost" @click="open=false">Close</button>
        </div>
        <div class="modal__body">
          <template x-if="item.src"><img :src="item.src" class="modal__image" /></template>
          <template x-if="!item.src"><div class="modal__empty">No inline preview for this file.</div></template>
        </div>
      </div>
    </div>
  </div>

  <!-- Provenance Modal -->
  <div x-data="{ open:false, trail:[], name:'' }" @open-provenance.window="trail=$event.detail.trail; name=$event.detail.name; open=true" x-show="open" x-transition.opacity class="modal" role="dialog" aria-modal="true">
    <div class="modal__backdrop" @click="open=false"></div>
    <div class="modal__panel modal__panel--sm">
      <div class="modal__content modal__content--sm">
        <div class="modal__header">
          <h4>Provenance — <span x-text="name"></span></h4>
          <button class="btn-ghost" @click="open=false">Close</button>
        </div>
        <ol class="modal__timeline">
          <template x-for="p in trail" :key="p.step">
            <li>
              <span class="timeline-dot"></span>
              <div>
                <p class="timeline-step" x-text="p.step"></p>
                <p class="timeline-detail" x-text="p.detail"></p>
              </div>
            </li>
          </template>
        </ol>
      </div>
    </div>
  </div>
</section>
{% endblock %}
